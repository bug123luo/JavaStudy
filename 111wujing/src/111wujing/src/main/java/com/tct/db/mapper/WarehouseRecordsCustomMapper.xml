<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tct.db.mapper.WarehouseRecordsCustomMapper">
	<sql id="allColumns">
		id,
		warehouse_id,
		warehouse_in_time,
		warehouse_out_time,
		web_user_id,
		app_id,
		gun_id,
		state,
		version,
		cancel_time
	</sql>
	<insert id="insertSelective" parameterType="com.tct.db.po.WarehouseRecords">
		<selectKey resultType="java.lang.Integer" order="AFTER" keyProperty="id">
			SELECT LAST_INSERT_ID()
		</selectKey>
		insert into warehouse_records
	    <trim prefix="(" suffix=")" suffixOverrides=",">
	     <if test="id != null">
	        id,
	      </if>
	      <if test="warehouseId != null">
	        warehouse_id,
	      </if>
	      <if test="warehouseInTime != null">
	        warehouse_in_time,
	      </if>
	      <if test="warehouseOutTime != null">
	        warehouse_out_time,
	      </if>
	      <if test="webUserId != null">
	        web_user_id,
	      </if>
	      <if test="appId != null">
	        app_id,
	      </if>
	      <if test="gunId != null">
	        gun_id,
	      </if>
	      <if test="state != null">
	        state,
	      </if>
	      <if test="version != null">
	        version,
	      </if>

	    </trim>
	    <trim prefix="values (" suffix=")" suffixOverrides=",">
	      <if test="id != null">
	        #{id,jdbcType=INTEGER},
	      </if>
	      <if test="warehouseId != null">
	        #{warehouseId,jdbcType=INTEGER},
	      </if>
	      <if test="warehouseInTime != null">
	        #{warehouseInTime,jdbcType=TIMESTAMP},
	      </if>
	      <if test="warehouseOutTime != null">
	        #{warehouseOutTime,jdbcType=TIMESTAMP},
	      </if>
	      <if test="webUserId != null">
	        #{webUserId,jdbcType=INTEGER},
	      </if>
	      <if test="appId != null">
	        #{appId,jdbcType=INTEGER},
	      </if>
	      <if test="gunId != null">
	        #{gunId,jdbcType=CHAR},
	      </if>
	      <if test="state != null">
	        #{state,jdbcType=INTEGER},
	      </if>
	      <if test="version != null">
	        #{version,jdbcType=INTEGER},
	      </if>
	    </trim>
	</insert>
	
	<update id="updateSelectiveByGunId" parameterType="com.tct.db.po.WarehouseRecords">
		update warehouse_records
		<set>
	      <if test="warehouseId != null">
	        warehouse_id = #{warehouseId,jdbcType=INTEGER},
	      </if>
	      <if test="warehouseInTime != null">
	        warehouse_in_time = #{warehouseInTime,jdbcType=TIMESTAMP},
	      </if>
	      <if test="warehouseOutTime != null">
	        warehouse_out_time = #{warehouseOutTime,jdbcType=TIMESTAMP},
	      </if>
	      <if test="webUserId != null">
	        web_user_id = #{webUserId,jdbcType=INTEGER},
	      </if>
	      <if test="appId != null">
	        app_id = #{appId,jdbcType=INTEGER},
	      </if>
	      <if test="state != null">
	        state = #{state,jdbcType=INTEGER},
	      </if>
	      <if test="version != null">
	        version = #{version,jdbcType=INTEGER},
	      </if>
          <if test="cancelTime != null">
	        cancel_time = #{cancelTime,jdbcType=TIMESTAMP},
	      </if>
	    </set>
	    where gun_id = #{gunId,jdbcType=CHAR}
	</update>
	
	<update id="updateSelectiveByGunIdAndOutState" parameterType="com.tct.db.po.WarehouseRecords">
		update warehouse_records
		<set>
	      <if test="warehouseId != null">
	        warehouse_id = #{warehouseId,jdbcType=INTEGER},
	      </if>
	      <if test="warehouseInTime != null">
	        warehouse_in_time = #{warehouseInTime,jdbcType=TIMESTAMP},
	      </if>
	      <if test="warehouseOutTime != null">
	        warehouse_out_time = #{warehouseOutTime,jdbcType=TIMESTAMP},
	      </if>
	      <if test="webUserId != null">
	        web_user_id = #{webUserId,jdbcType=INTEGER},
	      </if>
	      <if test="appId != null">
	        app_id = #{appId,jdbcType=INTEGER},
	      </if>
	      <if test="state != null">
	        state = #{state,jdbcType=INTEGER},
	      </if>
	      <if test="version != null">
	        version = #{version,jdbcType=INTEGER},
	      </if>
          <if test="cancelTime != null">
	        cancel_time = #{cancelTime,jdbcType=TIMESTAMP},
	      </if>
	    </set>
	    where gun_id = #{gunId,jdbcType=CHAR} and (state !=3 and state!=4)
	</update>
	
	<select id="selectByGunIdAndState" parameterType="com.tct.db.po.WarehouseRecordsQueryVo" resultType="com.tct.db.po.WarehouseRecordsCustom">
		select <include refid="allColumns"/> from warehouse_records
		<trim prefix="WHERE (" suffix=")" prefixOverrides="AND |OR ">
 			<if test="warehouseRecordsCustom.gunId !=null">
 				gun_id=#{warehouseRecordsCustom.gunId}
 			</if>
 			<if test="1==1">
 				and (allot_state=1 or allot_state=2 or allot_state=3)
 			</if>
 		</trim>
	</select>
	
	<update id="updateSelectiveByGunIdAndInState" parameterType="com.tct.db.po.WarehouseRecords">
		update warehouse_records
		<set>
	      <if test="warehouseId != null">
	        warehouse_id = #{warehouseId,jdbcType=INTEGER},
	      </if>
	      <if test="warehouseInTime != null">
	        warehouse_in_time = #{warehouseInTime,jdbcType=TIMESTAMP},
	      </if>
	      <if test="warehouseOutTime != null">
	        warehouse_out_time = #{warehouseOutTime,jdbcType=TIMESTAMP},
	      </if>
	      <if test="webUserId != null">
	        web_user_id = #{webUserId,jdbcType=INTEGER},
	      </if>
	      <if test="appId != null">
	        app_id = #{appId,jdbcType=INTEGER},
	      </if>
	      <if test="state != null">
	        state = #{state,jdbcType=INTEGER},
	      </if>
	      <if test="version != null">
	        version = #{version,jdbcType=INTEGER},
	      </if>
          <if test="cancelTime != null">
	        cancel_time = #{cancelTime,jdbcType=TIMESTAMP},
	      </if>
	    </set>
	    where gun_id = #{gunId,jdbcType=CHAR} and state = 2
	</update>
	
	<update id="updateSelectiveByGunIdAndRollbackState" parameterType="com.tct.db.po.WarehouseRecords">
		update warehouse_records
		<set>
	      <if test="warehouseId != null">
	        warehouse_id = #{warehouseId,jdbcType=INTEGER},
	      </if>
	      <if test="warehouseInTime != null">
	        warehouse_in_time = #{warehouseInTime,jdbcType=TIMESTAMP},
	      </if>
	      <if test="warehouseOutTime != null">
	        warehouse_out_time = #{warehouseOutTime,jdbcType=TIMESTAMP},
	      </if>
	      <if test="webUserId != null">
	        web_user_id = #{webUserId,jdbcType=INTEGER},
	      </if>
	      <if test="appId != null">
	        app_id = #{appId,jdbcType=INTEGER},
	      </if>
	      <if test="state != null">
	        state = #{state,jdbcType=INTEGER},
	      </if>
	      <if test="version != null">
	        version = #{version,jdbcType=INTEGER},
	      </if>
          <if test="cancelTime != null">
	        cancel_time = #{cancelTime,jdbcType=TIMESTAMP},
	      </if>
	    </set>
	    where gun_id = #{gunId,jdbcType=CHAR} and state = 3
	</update>
	
	
	<select id="selectByGunIdAndInState" parameterType="com.tct.db.po.WarehouseRecordsQueryVo" resultType="com.tct.db.po.WarehouseRecordsCustom">
		select <include refid="allColumns"/> from warehouse_records
		<trim prefix="WHERE (" suffix=")" prefixOverrides="AND |OR ">
 			<if test="warehouseRecordsCustom.gunId !=null">
 				gun_id=#{warehouseRecordsCustom.gunId}
 			</if>
 			<if test="1==1">
 				and state = #{warehouseRecordsCustom.state}
 			</if>
 		</trim>
	</select>
	
	<update id="updateSelectiveByGunIdAndMaxTime" parameterType="com.tct.db.po.WarehouseRecords">
		update warehouse_records
		<set>
	      <if test="warehouseId != null">
	        warehouse_id = #{warehouseId,jdbcType=INTEGER},
	      </if>
	      <if test="warehouseInTime != null">
	        warehouse_in_time = #{warehouseInTime,jdbcType=TIMESTAMP},
	      </if>
	      <if test="warehouseOutTime != null">
	        warehouse_out_time = #{warehouseOutTime,jdbcType=TIMESTAMP},
	      </if>
	      <if test="webUserId != null">
	        web_user_id = #{webUserId,jdbcType=INTEGER},
	      </if>
	      <if test="appId != null">
	        app_id = #{appId,jdbcType=INTEGER},
	      </if>
	      <if test="state != null">
	        state = #{state,jdbcType=INTEGER},
	      </if>
	      <if test="version != null">
	        version = #{version,jdbcType=INTEGER},
	      </if>
          <if test="cancelTime != null">
	        cancel_time = #{cancelTime,jdbcType=TIMESTAMP},
	      </if>
	    </set>
	    where gun_id = #{gunId,jdbcType=CHAR} and warehouse_out_time = (select MAX(warehouse_out_time) from warehouse_records where gun_id = #{gunId,jdbcType=CHAR})
	</update>
	
</mapper>